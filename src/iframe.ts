import { RpcServer } from '@nimiq/rpc';
import { BrowserDetection } from '@nimiq/utils';
import { WalletStore } from '@/lib/WalletStore';
import { WalletInfoEntry } from '@/lib/WalletInfo';
import CookieJar from '@/lib/CookieJar';

class IFrameApi {
    public static run() {
        const rpcServer = new RpcServer(IFrameApi.allowedOrigin);

        // Register handlers
        rpcServer.onRequest('list', IFrameApi.list);

        rpcServer.init();
    }

    public static async list(): Promise<WalletInfoEntry[]> {
        let wallets: WalletInfoEntry[];
        if (BrowserDetection.isIOS() || BrowserDetection.isSafari()) {
            wallets = await CookieJar.eat();
        } else {
            wallets = await WalletStore.Instance.list();
        }
        if (wallets.length > 0) {
            return wallets;
        }

        // If no wallets exist, see if the Keyguard has keys
        const client = new (await import('@nimiq/keyguard-client')).KeyguardClient('https://keyguard.nimiq-testnet.com');
        const hasKeys = await client.hasKeys();
        if (hasKeys) {
            throw new Error('WALLETS_LOST');
        }

        // If no keys exist, check for legacy accounts
        const hasLegacyAccounts = await client.hasLegacyAccounts();
        if (hasLegacyAccounts) {
            throw new Error('MIGRATION_REQUIRED');
        }

        return [];
    }

    private static get allowedOrigin(): string {
        switch (window.location.origin) {
            case 'https://accounts.nimiq.com': return 'https://safe-next.nimiq.com';
            // FIXME We need to support safe-next and safe currently. TODO: make RpcServer accept an array of origins.
            case 'https://accounts.nimiq-testnet.com': return '*';
            default: return '*';
        }
    }
}

IFrameApi.run();
